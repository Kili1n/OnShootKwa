<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Presse</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="mobile.css">

    <style>
        :root {
            --bg-color: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --accent: #0071E3;
            --border-color: rgba(0, 0, 0, 0.08);
            --shadow-sm: 0 1px 4px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --font-main: 'Inter', sans-serif;
            --tag-bg: #F2F2F7;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-width: 1200px;
            padding-bottom: 60px;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(245, 245, 247, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 40px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: all 0.3s ease;
        }

        header.scrolled {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            background: rgba(255, 255, 255, 0.95);
        }

        .header-top, .header-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .brand { 
            font-size: 20px; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            cursor: pointer; 
            min-width: 200px;
        }
        .brand i { color: var(--accent); }

        .nav-controls { display: flex; gap: 12px; align-items: center; }

        .search-group { position: relative; display: flex; align-items: center; }
        .search-group i { position: absolute; left: 12px; font-size: 13px; color: var(--text-secondary); }
        
        .location-group { display: flex; gap: 8px; }

        .loc-input {
            padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 8px;
            font-family: var(--font-main); font-size: 13px; color: var(--text-primary);
            background: #FFF; outline: none; height: 36px; transition: border 0.2s;
            width: 160px;
        }
        .search-input { padding-left: 32px !important; width: 220px; }

        .icon-btn {
            width: 36px; height: 36px; border: 1px solid var(--border-color); border-radius: 8px;
            background: #FFF; color: var(--text-secondary); cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .icon-btn:hover:not(:disabled) { color: var(--accent); border-color: var(--accent); }
        .icon-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .icon-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Bouton Calcul */
        .calc-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0 16px;
            font-weight: 600;
            font-size: 13px;
            width: auto;
            gap: 8px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            height: 36px;
        }
        .calc-btn:hover:not(:disabled) { background: #005bb7; }

        .filter-group { display: flex; align-items: center; gap: 12px; }
        .control-input {
            padding: 0 10px; border: 1px solid var(--border-color); border-radius: 8px;
            font-family: var(--font-main); font-size: 13px; color: var(--text-primary);
            background: #FFF; outline: none; height: 32px;
        }

        .filter-label { font-size: 11px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-right: 4px; }

        .ui-group {
            display: flex; align-items: center; gap: 8px; background: #FFF;
            padding: 0 10px; border-radius: 8px; border: 1px solid var(--border-color); height: 32px;
        }
        
        .switch { position: relative; display: inline-block; width: 30px; height: 16px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .3s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px;
            background-color: white; transition: .3s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(14px); }

        .filters { display: flex; gap: 6px; background: #E8E8ED; padding: 3px; border-radius: 10px; }
        .filter-btn { 
            border: none; background: transparent; padding: 6px 16px; 
            font-family: var(--font-main); font-size: 13px; font-weight: 600; 
            color: var(--text-secondary); border-radius: 7px; cursor: pointer; 
        }
        .filter-btn.active { background: #FFFFFF; color: var(--text-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .container { max-width: 1800px; margin: 30px auto; padding: 0 40px; }
        .matches-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 20px; 
        }

        .card { 
            background: var(--card-bg); border-radius: var(--radius); padding: 16px;
            box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); 
            display: flex; flex-direction: column; gap: 12px; transition: transform 0.2s; 
        }
        .card:hover { transform: translateY(-2px); border-color: var(--accent); }

        .match-header { display: flex; justify-content: space-between; align-items: center; }
        .team { display: flex; flex-direction: column; align-items: center; gap: 4px; width: 42%; text-align: center; }
        .team-logo { width: 42px; height: 42px; object-fit: contain; } 
        .team-name { font-weight: 600; font-size: 13px; line-height: 1.1; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; height: 28px; }
        .vs { font-size: 10px; color: var(--text-secondary); font-weight: 700; margin-top: -15px; }

        .match-meta { 
            display: flex; justify-content: space-between; align-items: center; 
            border-top: 1px solid var(--border-color); padding-top: 10px; 
        }
        .badge { 
            padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; 
            text-transform: uppercase; background: var(--tag-bg); color: var(--text-primary); 
            display: flex; align-items: center; gap: 5px;
        }
        .date-time { font-size: 12px; color: var(--text-primary); font-weight: 500; }

        .transport-block { 
            background: #FAFAFA; border-radius: 8px; padding: 8px 10px; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .distance { font-weight: 700; font-size: 12px; }
        .modes { display: flex; gap: 10px; }
        .mode { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text-secondary); }
        .mode i { color: var(--accent); font-size: 10px; }

        .accred-footer { margin-top: auto; padding-top: 10px; border-top: 1px solid var(--border-color); font-size: 11px; display: flex; justify-content: space-between; align-items: center;}
        .accred-status { display: flex; align-items: center; gap: 6px; font-weight: 500; width: 100%; }
        .accred-available { color: #34C759; }
        .accred-unavailable { color: var(--text-secondary); opacity: 0.7; }
        .accred-email { color: var(--text-primary); text-decoration: none; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }

        .error-msg { grid-column: 1 / -1; text-align: center; color: #ef4444; background: #fee2e2; padding: 20px; border-radius: 12px; }
        
        /* Menu Toggle Mobile (Cach√© sur desktop) */
        .menu-toggle { display: none; background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-primary); }
    </style>
</head>
<body>

    <header id="mainHeader">
        <div class="header-top">
            <div class="brand" id="siteLogo">
                <i class="fa-solid fa-map-location-dot"></i>
                Dashboard Presse
                <button id="menuToggle" class="menu-toggle"><i class="fa-solid fa-bars"></i></button>
            </div>

            <div class="nav-controls">
                <div class="search-group">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="searchInput" class="loc-input search-input" placeholder="Rechercher un club...">
                </div>

                <div class="location-group">
                    <button class="icon-btn" id="gpsBtn" title="Ma position actuelle"><i class="fa-solid fa-location-crosshairs"></i></button>
                    <button class="calc-btn" id="calcDistBtn">
                        <i class="fa-solid fa-route"></i> Calculer les distances
                    </button>
                </div>
            </div>
        </div>

        <div class="header-bottom">
            <div class="filters">
                <button class="filter-btn active" data-filter="all">Tous</button>
                <button class="filter-btn" data-filter="football">Foot</button>
                <button class="filter-btn" data-filter="basketball">Basket</button>
                <button class="filter-btn" data-filter="handball">Hand</button>
            </div>

            <div class="filter-group">
                <select id="compFilter" class="control-input">
                    <option value="all">üìä Toutes comp√©titions</option>
                </select>

                <input type="week" id="weekFilter" class="control-input">

                <div class="ui-group">
                    <span class="filter-label">Tri</span>
                    <select id="sortFilter" class="control-input" style="border:none;">
                        <option value="date">üìÖ Date</option>
                        <option value="distance">üìç Distance</option>
                        <option value="level">üèÜ Niveau</option>
                    </select>
                </div>

                <div class="ui-group">
                    <span class="filter-label">Accr√©d.</span>
                    <label class="switch">
                        <input type="checkbox" id="accredToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="matches-grid" id="grid"></div>
    </div>

    <script src="config.js"></script> 
    <script>
        const GEOAPIFY_KEY = "61ca90447ebd483ab2f002050433fa42"; 
        const LOGO_TOKEN = "pk_ZMm3eD-YScqxE9anYdSV8g";
        const SPORT_EMOJIS = { "football": "‚öΩ", "basketball": "üèÄ", "handball": "ü§æ"};

        // √âtats globaux
        let allMatches = [];
        let currentlyFiltered = []; 
        let currentFilters = { week: "", comp: "all", sport: "all", accredOnly: false, sortBy: "date", search: "" };
        let userPosition = null;
        let isCalculating = false;
        const travelCache = new Map();

        const normalize = (str) => {
            if (!str) return '';
            return str.toUpperCase()
                .replace(/[^A-Z0-9]/g, '') 
                .replace(/FC$|SFC$|SC$|FOOTBALL$|JEANNEDARC$|\d+$/g, '');
        };

        const getLogoUrl = (name) => {
            const upperName = name.toUpperCase();
            const customKey = Object.keys(CUSTOM_LOGOS).find(key => upperName.includes(key));
            if (customKey) return CUSTOM_LOGOS[customKey];
            let cleanName = normalize(name);
            return `https://img.logo.dev/name/${encodeURIComponent(cleanName.toLowerCase())}?token=${LOGO_TOKEN}`;
        };

        const formatCompetition = (rawName, sport) => {
            if (!rawName) return "MATCH";
            const name = rawName.toUpperCase();
            const s = (sport).toLowerCase();
            let sportLabel = s.includes("basket") ? "BASKET" : (s.includes("foot") ? "FOOT" : "HAND");
            
            let level = "REG", age = "SENIOR";
            if (name.includes("BETCLIC") || name.includes("STARLIGUE")) {level = "L1"}
            else if (name.includes("BUTAGAZ") || name.includes("LBWL")) { level = "L1"; age = "SENIOR F"; }
            else if (name.includes("√âLIT2") || name.includes("PROLIGUE")) { level = "L2"; }
            else if (name.includes("LF2")) { level = "L2"; age = "SENIOR F"; }
            else if (name.includes("NF1")) { level = "N1"; age = "SENIOR F"; }
            else if (name.includes("ESPOIRS")) { level = "L1"; age = "U21"; }
            else if (name.includes("NATIONALE 1")) { level = "N1"; }
            else {
                const isFeminine = name.includes("F√âMININ") || name.includes("FEMININ") || name.includes(" F ");
                if (name.includes("N3")) level = "N3";
                else if (name.includes("N2")) level = "N2";
                else if (name.includes("D3") && (name.includes("F√âMININE") || name.includes("FEMININE"))) level = "L3";
                else if (name.includes("NATIONAL") || name.includes("NAT")) level = "NAT";
                if (name.includes("U19")) age = "U19";
                else if (name.includes("U17")) age = "U17";
                if (isFeminine && !age.includes("F")) age += " F";
            }
            return `${sportLabel} - ${level} - ${age}`;
        };

        const getAccreditationHTML = (teamName) => {
            const key = Object.keys(ACCRED_LIST).find(k => teamName.toUpperCase().includes(k));
            if (key) {
                const contact = ACCRED_LIST[key];
                const href = contact.startsWith('http') ? contact : `mailto:${contact}`;
                return `<div class="accred-status accred-available"><i class="fa-solid fa-check-circle"></i> <a href="${href}" class="accred-email">${contact}</a></div>`;
            }
            return `<div class="accred-status accred-unavailable"><i class="fa-solid fa-circle-xmark"></i> <span>Inconnu</span></div>`;
        };

        const getTeamCoords = (name) => {
            const upperName = name.toUpperCase();
            const key = Object.keys(STADIUM_COORDS).find(k => upperName.includes(k));
            return key ? STADIUM_COORDS[key] : null;
        };

        async function fetchTravelData(uLat, uLon, dLat, dLon) {
            const cacheKey = `${uLat},${uLon},${dLat},${dLon}`;
            if (travelCache.has(cacheKey)) return travelCache.get(cacheKey);

            try {
                const url = `https://api.geoapify.com/v1/routing?waypoints=${uLat},${uLon}|${dLat},${dLon}&mode=drive&apiKey=${GEOAPIFY_KEY}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.features?.length > 0) {
                    const props = data.features[0].properties;
                    const result = { dist: Math.round(props.distance / 1000), car: Math.round(props.time / 60) };
                    travelCache.set(cacheKey, result);
                    return result;
                }
            } catch (e) { console.warn(e); }
            return null;
        }

        async function updateDistances() {
            if (isCalculating || !userPosition) {
                if(!userPosition) alert("Veuillez d'abord activer votre position GPS.");
                return;
            }

            isCalculating = true;
            const btn = document.getElementById('calcDistBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Calcul...';

            // On ne calcule que pour les matchs actuellement filtr√©s (limit√© aux 20 premiers pour l'API)
            const targets = currentlyFiltered.slice(0, 20);

            for (let m of targets) {
                if (m.locationCoords && m.distance === 0) {
                    m.isCalculating = true;
                    renderMatches(currentlyFiltered); 

                    const travel = await fetchTravelData(userPosition.lat, userPosition.lon, m.locationCoords.lat, m.locationCoords.lon);
                    if (travel) {
                        m.distance = travel.dist;
                        m.times.car = travel.car;
                        m.times.public = Math.round(travel.car * 1.5 + 15);
                    }
                    m.isCalculating = false;
                }
            }

            isCalculating = false;
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-route"></i> Calculer les distances';
            applyFilters();
        }

        async function loadMatches() {
            try {
                const response = await fetch('matchs.json');
                const data = await response.json();
                allMatches = data.map(m => ({
                    sport: m.sport,
                    compFormatted: formatCompetition(m.competition, m.sport),
                    home: { name: m.home }, 
                    away: { name: m.away },
                    dateDisplay: m.date,
                    dateObj: new Date(m.isoDate), 
                    locationCoords: getTeamCoords(m.home),
                    distance: 0,
                    times: { car: 0, public: 0 },
                    isCalculating: false
                })).sort((a, b) => a.dateObj - b.dateObj);
                
                applyFilters();
            } catch (error) {
                document.getElementById('grid').innerHTML = `<div class="error-msg">Erreur de chargement.</div>`;
                console.error("D√©tail de l'erreur :", error);
            }
        }

        function requestUserLocation() {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    userPosition = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    document.getElementById('gpsBtn').classList.add('active');
                });
            }
        }

        function populateCompFilter(filteredMatches) {
            const select = document.getElementById('compFilter');
            const savedValue = currentFilters.comp;
            select.innerHTML = '<option value="all">üìä Toutes comp√©titions</option>';
            const uniqueComps = [];
            const seen = new Set();
            filteredMatches.forEach(m => {
                if (!seen.has(m.compFormatted)) {
                    seen.add(m.compFormatted);
                    uniqueComps.push({ name: m.compFormatted, sport: m.sport.toLowerCase() });
                }
            });
            uniqueComps.sort((a, b) => a.name.localeCompare(b.name)).forEach(c => {
                const emoji = SPORT_EMOJIS[c.sport] || "üèüÔ∏è";
                const opt = document.createElement('option');
                opt.value = c.name;
                opt.textContent = `${emoji} ${c.name}`;
                if (c.name === savedValue) opt.selected = true;
                select.appendChild(opt);
            });
            if (!seen.has(savedValue)) currentFilters.comp = "all";
        }

        function resetFilters() {
            currentFilters = { week: "", comp: "all", sport: "all", accredOnly: false, sortBy: "date", search: "" };
            
            // Reset des √©l√©ments UI
            document.getElementById('weekFilter').value = "";
            document.getElementById('compFilter').value = "all";
            document.getElementById('sortFilter').value = "date";
            document.getElementById('searchInput').value = "";
            document.getElementById('accredToggle').checked = false;
            // Supprim√© cityInput qui n'existe pas
            
            document.getElementById('gpsBtn').classList.remove('active');
            userPosition = null;

            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
            
            applyFilters();
        }
        
        function applyFilters() {
            let filtered = [...allMatches];

            if (currentFilters.search) {
                const term = currentFilters.search.toLowerCase();
                filtered = filtered.filter(m => m.home.name.toLowerCase().includes(term) || m.away.name.toLowerCase().includes(term));
            }

            if (currentFilters.sport !== "all") {
                filtered = filtered.filter(m => m.sport.toLowerCase() === currentFilters.sport);
            }

            populateCompFilter(filtered);

            if (currentFilters.comp !== "all") {
                filtered = filtered.filter(m => m.compFormatted === currentFilters.comp);
            }

            if (currentFilters.accredOnly) {
                const accredKeys = Object.keys(ACCRED_LIST);
                filtered = filtered.filter(m => accredKeys.some(key => m.home.name.toUpperCase().includes(key)));
            }

            if (currentFilters.week) {
                filtered = filtered.filter(m => {
                    const date = m.dateObj;
                    const jan1 = new Date(date.getFullYear(), 0, 1);
                    const weekNum = Math.ceil((((date - jan1) / 86400000) + jan1.getDay() + 1) / 7);
                    const matchWeek = `${date.getFullYear()}-W${weekNum.toString().padStart(2, '0')}`;
                    return matchWeek === currentFilters.week;
            });
}

            filtered.sort((a, b) => {
                if (currentFilters.sortBy === "distance") {
                    return (a.distance || 9999) - (b.distance || 9999);
                }
                if (currentFilters.sortBy === "level") {
                    const priority = { "L1": 1, "L2": 2, "N1": 3, "N2": 4, "N3": 5, "NAT": 6, "REG": 7 };
                    const getLevel = (comp) => comp.split(' - ')[1] || "REG";
                    return (priority[getLevel(a.compFormatted)] || 99) - (priority[getLevel(b.compFormatted)] || 99);
                }
                return a.dateObj - b.dateObj;
            });

            currentlyFiltered = filtered;
            renderMatches(filtered);
        }

        function renderMatches(data) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            data.forEach(m => {
                const card = document.createElement('article');
                card.className = 'card';
                const emoji = SPORT_EMOJIS[m.sport.toLowerCase()] || "üèüÔ∏è";
                
                // Affichage propre de la distance (pas de 0km)
                const distText = m.isCalculating ? '<i class="fa-solid fa-spinner fa-spin"></i>' : (m.distance > 0 ? `${m.distance} km` : '-- km');

                card.innerHTML = `
                    <div class="match-header">
                        <div class="team">
                            <img src="${getLogoUrl(m.home.name)}" class="team-logo" onerror="this.src='https://placehold.co/42x42/png?text=H'">
                            <span class="team-name">${m.home.name}</span>
                        </div>
                        <div class="vs">VS</div>
                        <div class="team">
                            <img src="${getLogoUrl(m.away.name)}" class="team-logo" onerror="this.src='https://placehold.co/42x42/png?text=A'">
                            <span class="team-name">${m.away.name}</span>
                        </div>
                    </div>
                    <div class="match-meta">
                        <span class="badge"><span>${emoji}</span> ${m.compFormatted}</span>
                        <span class="date-time">${m.dateDisplay}</span>
                    </div>
                    <div class="transport-block">
                        <div class="distance">${distText}</div>
                        <div class="modes">
                            <div class="mode"><i class="fa-solid fa-car"></i> ${m.times.car || '--'}'</div>
                            <div class="mode"><i class="fa-solid fa-train-subway"></i> ${m.times.public || '--'}'</div>
                        </div>
                    </div>
                    <div class="accred-footer">${getAccreditationHTML(m.home.name)}</div>
                `;
                grid.appendChild(card);
            });
        }

        // Listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadMatches();
            
            document.getElementById('calcDistBtn').addEventListener('click', updateDistances);
            document.getElementById('gpsBtn').addEventListener('click', requestUserLocation);

            document.getElementById('searchInput').addEventListener('input', e => {
                currentFilters.search = e.target.value;
                applyFilters();
            });

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelector('.filter-btn.active').classList.remove('active');
                    btn.classList.add('active');
                    currentFilters.sport = btn.dataset.filter;
                    applyFilters();
                });
            });

            document.getElementById('siteLogo').addEventListener('click', resetFilters);
            document.getElementById('weekFilter').addEventListener('change', e => { currentFilters.week = e.target.value; applyFilters(); });
            document.getElementById('compFilter').addEventListener('change', e => { currentFilters.comp = e.target.value; applyFilters(); });
            document.getElementById('sortFilter').addEventListener('change', e => { currentFilters.sortBy = e.target.value; applyFilters(); });
            document.getElementById('accredToggle').addEventListener('change', e => { currentFilters.accredOnly = e.target.checked; applyFilters(); });
            document.getElementById('gpsBtn').addEventListener('click', requestUserLocation);
            
            window.addEventListener('scroll', () => {
                document.getElementById('mainHeader').classList.toggle('scrolled', window.scrollY > 20);
            });

            document.getElementById('menuToggle').addEventListener('click', () => {
                document.getElementById('mainHeader').classList.toggle('menu-open');
            });
        });
    </script>
</body>
</html>
    